import { Text, TouchableOpacity, View, SafeAreaView, Pressable, TouchableWithoutFeedback, ScrollView, Modal, StyleSheet, FlatList } from 'react-native';
import { useState, useEffect } from 'react';
import Collapsible from 'react-native-collapsible';
import useAppwrite from '@/lib/useAppwrite';
import { getAllResults, getAllDistrics, getAllPrgrams, getItemByItemcode } from '@/lib/appwrite';
import Animation from '@/components/Animation';
import { DataTable } from 'react-native-paper';


const ScoreBoard = () => {
  const [openIndex, setOpenIndex] = useState(null);
  const { data: latestAllResults } = useAppwrite(getAllResults);
  const { data: districts } = useAppwrite(() => getAllDistrics());
  const { data: programs } = useAppwrite(() => getAllPrgrams());
  const [districtCategoryMarks, setDistrictCategoryMarks] = useState({});
  const [districtTotals, setDistrictTotals] = useState({});
  const [generalTotals, setGeneralTotals] = useState({});
  const [twalabaTotals, setTwalabaTotals] = useState({});
  const [showAllGrandTotal, setShowAllGrandTotal] = useState(false);
  const [showAllGeneral, setShowAllGeneral] = useState(false);
  const [showAllTwalaba, setShowAllTwalaba] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [modalVisible, setModalVisible] = useState(false);
  const [modalContent, setModalContent] = useState(null);

  const getcat = (itemcode, callback) => {
    try {
      getItemByItemcode(itemcode)
        .then((pointCategory) => {
          callback(pointCategory); // Pass the fetched data to the callback
        })
        .catch((error) => {
          console.error("Error fetching point category:", error);
        });
    } catch (error) {
      console.error("Error fetching point category:", error);
    }
  };

  const closeModal = () => {
    setModalVisible(false);
  };

  const getRankClasses = (rank) => {
    switch (rank) {
      case 1:
        return 'bg-green-400 ';
      case 2:
        return 'bg-orange-400 ';
      case 3:
        return 'bg-blue-400 ';
      default:
        return 'bg-gray-300 ';
    }
  };


  const getRankBorderClasses = (rank) => {
    switch (rank) {
      case 1:
        return ' border-green-200';
      case 2:
        return 'border-orange-200';
      case 3:
        return 'border-blue-200';
      default:
        return 'border-gray-200';
    }
  };
  const scoreTable = {
    A: { position: { First: 10, Second: 7, Third: 5 }, grade: { A: 5, B: 3, C: 1, 0: 0 } },
    B: { position: { First: 7, Second: 5, Third: 3 }, grade: { A: 5, B: 3, C: 1, 0: 0 } },
    C: { position: { First: 5, Second: 3, Third: 1 }, grade: { A: 5, B: 3, C: 1, 0: 0 } },
    Group: { position: { First: 10, Second: 7, Third: 5 }, grade: { A: 10, B: 8, C: 6, 0: 0 } },
  };

  const generalSubcategories = ['G.K', 'G.SJ', 'G.J', 'G.S', 'G.SS', 'G.G'];
  const twalabaSubcategories = ['T.J', 'T.S', 'T.G'];

  const groupedData = latestAllResults.reduce((acc, item) => {
    const districtIds = [
      { id: item.firstdistrict, mark: item.firstmark, category: item.categorycode, source: 'first', grade: item.firstgrade },
      { id: item.seconddistrict, mark: item.secondmark, category: item.categorycode, source: 'second', grade: item.secondgrade },
      { id: item.thirddistrict, mark: item.thirdmark, category: item.categorycode, source: 'third', grade: item.thirdgrade },
    ];

    districtIds.forEach(districtData => {
      const { id: districtId, mark, category, source, grade } = districtData;

      if (!acc[districtId]) {
        acc[districtId] = {
          categories: {},
        };
      }

      if (!acc[districtId].categories[category]) {
        acc[districtId].categories[category] = [];
      }

      acc[districtId].categories[category].push({
        itemCode: item.itemcode,
        mark,
        source,
        grade,
      });
    });

    return acc;
  }, {});

  // Now, let's process the grouped data to assign the "First", "Second", and "Third" labels:
  for (const districtId in groupedData) {
    //console.log(`District ID: ${districtId}`);

    for (const category in groupedData[districtId].categories) {
      //console.log(`  Category: ${category}`);

      const items = groupedData[districtId].categories[category];
      items.sort((a, b) => b.mark - a.mark);

      items.forEach((item, index) => {


        // Assign label based on the source of the mark
        item.label = item.source === 'first' ? 'First' : item.source === 'second' ? 'Second' : 'Third';

        //console.log(`- Item Code: ${item.itemCode}, Mark: ${item.mark}, Source: ${item.source}, Grade: ${item.grade}, Label: ${item.label}`);
      });
    }
  }

  // console.log(groupedData);

  const calculateDistrictData = (data) => {
    const districtCategoryMarks = {};
    const onlyGradeMarks = {};  // Declare this outside so it persists across iterations
    const totals = {};
    const generalTotals = {};
    const twalabaTotals = {};
  

    data.forEach((item) => {
      const districtIds = [
        { id: item.firstdistrict, mark: Number(item.firstmark) || 0, category: item.categorycode },
        { id: item.seconddistrict, mark: Number(item.secondmark) || 0, category: item.categorycode },
        { id: item.thirddistrict, mark: Number(item.thirdmark) || 0, category: item.categorycode },
      ];
  
      districtIds.forEach(({ id, mark, category }) => {
        if (!districtCategoryMarks[id]) {
          districtCategoryMarks[id] = { general: {}, twalaba: {} };
        }
  
        if (category?.startsWith('G') && generalSubcategories.includes(category)) {
          districtCategoryMarks[id].general[category] =
            (districtCategoryMarks[id].general[category] || 0) + mark;
        }
  
        if (category?.startsWith('T') && twalabaSubcategories.includes(category)) {
          districtCategoryMarks[id].twalaba[category] =
            (districtCategoryMarks[id].twalaba[category] || 0) + mark;
        }
  
        getcat(item.itemcode, (pointCategory) => {
          if (!pointCategory) {
            console.error("Invalid pointCategory:", pointCategory);
            return;
          }
  
          if (item.gradesonly.length) {
            const gradesOnlyData = JSON.parse(item.gradesonly);
  
            for (const gradeCategory in gradesOnlyData) {
              const districtIds = gradesOnlyData[gradeCategory];
              const gradePoint = scoreTable[pointCategory.point_category].grade[gradeCategory];
  
              districtIds.forEach(districtId => {
                if (!onlyGradeMarks[districtId]) {
                  onlyGradeMarks[districtId] = {};
                }
  
                const maincategory = pointCategory.category_code.startsWith('G') ? 'general' : 'twalaba';
                const subcategory = pointCategory.category_code;
  
                if (!onlyGradeMarks[districtId][maincategory]) {
                  onlyGradeMarks[districtId][maincategory] = {};
                }
  
                // Add or update the grade point for the district, maincategory, and subcategory
                if (!onlyGradeMarks[districtId][maincategory][subcategory]) {
                  onlyGradeMarks[districtId][maincategory][subcategory] = 0;
                }
                onlyGradeMarks[districtId][maincategory][subcategory] += gradePoint;
              });
            }
          }
      console.log("Final onlyGradeMssssssssssssssssarks:", onlyGradeMarks);

        });
     

      });
    
      // Log the final onlyGradeMarks after all iterations
    
     
    });
  
    // Log onlyGradeMarks after the loop is finished
    console.log(onlyGradeMarks,"Final onlyGradeMarks:");
  
    // Now calculate totals and return the results
    Object.keys(districtCategoryMarks).forEach((districtId) => {
      const generalTotal = Object.values(districtCategoryMarks[districtId].general).reduce((a, b) => a + b, 0);
      const twalabaTotal = Object.values(districtCategoryMarks[districtId].twalaba).reduce((a, b) => a + b, 0);
      const grandTotal = generalTotal + twalabaTotal;
  
      totals[districtId] = grandTotal;
      generalTotals[districtId] = generalTotal;
      twalabaTotals[districtId] = twalabaTotal;
    });
  
    // Return all data, including the final onlyGradeMarks
      console.log(onlyGradeMarks,"ss");
    return { districtCategoryMarks, totals, generalTotals, twalabaTotals, onlyGradeMarks };
  };


  
  // Example of how to call the function and log the final onlyGradeMarks
  //const result = calculateDistrictData(yourData);
  //console.log(result.onlyGradeMarks, "onlyGradeMarks");
  
  


  useEffect(() => {
    if (latestAllResults && districts) {
      const { districtCategoryMarks, totals, generalTotals, twalabaTotals } = calculateDistrictData(latestAllResults);
      setDistrictCategoryMarks(districtCategoryMarks);
      setDistrictTotals(totals);
      setGeneralTotals(generalTotals);
      setTwalabaTotals(twalabaTotals);
      setIsLoading(false);
    }
  }, [latestAllResults, districts]);

  const districtMap = districts.reduce((acc, district) => {
    if (district.districtid && district.name) {
      acc[district.districtid] = district.name;
    } else {
      console.warn("Invalid district entry:", district);
    }
    return acc;
  }, {});

  const getRankedData = (data) => {
    const sorted = Object.entries(data)
      .sort(([, a], [, b]) => b - a)
      .map(([districtId, total], index, arr) => ({
        districtId,
        total,
        rank: index > 0 && total === arr[index - 1].total ? arr[index - 1].rank : index + 1,
      }));
    return sorted;
  };

  const adjustRankSlice = (rankedData, showAll) => {
    if (showAll) return rankedData;

    let limit = 3;
    for (let i = 0; i < rankedData.length; i++) {
      if (i >= limit) break;
      if (i < rankedData.length - 1 && rankedData[i].rank === rankedData[i + 1].rank) {
        limit++;
      }
    }
    return rankedData.slice(0, limit);
  };

  const sortedGrandTotal = getRankedData(districtTotals);
  const sortedGeneralTotal = getRankedData(generalTotals);
  const sortedTwalabaTotal = getRankedData(twalabaTotals);

  const toggleCollapse = (index) => {
    setOpenIndex(openIndex === index ? null : index);
  };

  const toggleViewGrandTotal = () => setShowAllGrandTotal(!showAllGrandTotal);
  const toggleViewGeneral = () => setShowAllGeneral(!showAllGeneral);
  const toggleViewTwalaba = () => setShowAllTwalaba(!showAllTwalaba);

  if (isLoading) {
    return <Animation />;
  }

  const ModalContent = ({ isVisible, onClose, content }) => {
    if (!content) return null;

    return (
      <Modal visible={isVisible} transparent={true} animationType="fade" onRequestClose={onClose}>
        <TouchableWithoutFeedback onPress={onClose}>
          <View style={styles.modalOverlay}>
            <TouchableWithoutFeedback>
              <View style={styles.modalContent}>
                <Text style={styles.modalText}>
                  {`District: ${content.districtId}\nSubcategory: ${content.subcategory}\nMarks: ${content.marks}`}
                </Text>
                <Text>{districtMap[content.districtId]} </Text>

                <ScrollView horizontal={true}>
                  <DataTable style={{ padding: 15 }}>
                    <DataTable.Header style={{ backgroundColor: "#DCDCDC" }}>
                      <DataTable.Title className='w-40 mr-4'>Item Name</DataTable.Title>
                      <DataTable.Title className='mr-4'>Point</DataTable.Title>
                      <DataTable.Title>Grade</DataTable.Title>
                      <DataTable.Title>Label</DataTable.Title>
                    </DataTable.Header>

                    {groupedData[content.districtId] &&
                      groupedData[content.districtId].categories &&
                      groupedData[content.districtId].categories[content.subcategory] &&
                      groupedData[content.districtId].categories[content.subcategory].length > 0 ? (
                      groupedData[content.districtId].categories[content.subcategory].map((item, index) => (
                        <DataTable.Row key={index}>
                          <DataTable.Cell className='w-40 mr-4'>{programs[item.itemCode].itemlabel}</DataTable.Cell>
                          <DataTable.Cell className='mr-4'>{item.mark}</DataTable.Cell>
                          <DataTable.Cell>{item.grade}</DataTable.Cell>
                          <DataTable.Cell>{item.label}</DataTable.Cell>
                        </DataTable.Row>
                      ))
                    ) : (
                      <DataTable.Row>
                        <DataTable.Cell colSpan={5}>No data available</DataTable.Cell>
                      </DataTable.Row>
                    )}
                  </DataTable>
                </ScrollView>

                <Pressable style={styles.closeButton} onPress={onClose}>
                  <Text style={styles.buttonText}>Close</Text>
                </Pressable>
              </View>
            </TouchableWithoutFeedback>
          </View>
        </TouchableWithoutFeedback>
      </Modal>
    );
  };

  const handleSubcategoryClick = (districtId, subcategory) => {
    const marks = districtCategoryMarks[districtId]?.[subcategory.startsWith('G') ? 'general' : 'twalaba'][subcategory] || 0;
    setModalContent({ districtId, subcategory, marks });
    setModalVisible(true);
  };

  return (
    <SafeAreaView className="px-4 my-6 bg-primary h-full">
      <ScrollView showsVerticalScrollIndicator={false}>
        <Text className="text-2xl text-white font-psemibold">Leaderboard</Text>

        {/* Grand Total Section */}
        <View>
          <Text className="text-xl text-white font-semibold">General Ultimate</Text>
          {adjustRankSlice(sortedGrandTotal, showAllGrandTotal).map(({ districtId, total, rank }) => {
            const rankClasses = getRankClasses(rank);
            const rankborderClasses = getRankBorderClasses(rank);

            return (
              <View key={`grand-${districtId}`}>
                <TouchableOpacity onPress={() => toggleCollapse(`grand-${districtId}`)} >
                  <View className="bg-black-100  p-2 rounded-lg my-2 flex flex-row gap-2 items-center">
                    <View className={`p-1 border rounded-full ${rankborderClasses}`}>
                      <View className={` w-16 h-16 text-center rounded-full  flex items-center justify-center ${rankClasses} `}>
                        <Text style={{ textShadow: '2px 2px 4px rgba(0, 0, 0, 0.6)' }} className="text-gray-800 text-center text-2xl font-pbold">{rank}</Text>
                      </View>
                    </View>
                    <Text className="text-white text-2xl font-psemibold "> {districtMap[districtId]} </Text>
                    <View>
                      <Text className="text-white font-pbold  text-4xl "> {total}</Text>
                    </View>
                  </View>
                </TouchableOpacity>
                <Collapsible collapsed={openIndex !== `grand-${districtId}`}>
                  <View className="bg-gray-200 p-2 rounded-md">
                    <View className="flex flex-row items-center  p-4 justify-between px-6 border-b border-1 border-gray-100">
                      <Text className="text-xl font-pmedium "> General:</Text>
                      <Text className="text-xl font-pmedium "> {generalTotals[districtId] || 0}</Text>
                    </View>
                    <View className="flex flex-row items-center p-4  justify-between px-6">
                      <Text className="text-xl font-pmedium "> Twalaba:</Text>
                      <Text className="text-xl font-pmedium "> {twalabaTotals[districtId] || 0}</Text>
                    </View>
                  </View>
                </Collapsible>
              </View>
            )
          })}
          <TouchableOpacity onPress={toggleViewGrandTotal} className="mt-2">
            <Text className="text-green-600">{showAllGrandTotal ? 'View Less' : 'View More'}</Text>
          </TouchableOpacity>
        </View>

        <ModalContent
          isVisible={modalVisible}
          onClose={closeModal}
          content={modalContent}
        />

        {/* General Category Section */}
        <View>
          <Text className="text-xl text-white font-semibold mt-4">General Dominant</Text>
          {adjustRankSlice(sortedGeneralTotal, showAllGeneral).map(({ districtId, total, rank }) => {
            const rankClasses = getRankClasses(rank);
            const rankborderClasses = getRankBorderClasses(rank);

            return (
              <View key={`general-${districtId}`}>
                <TouchableOpacity onPress={() => toggleCollapse(`general-${districtId}`)}>

                  <View className="bg-black-100  p-2 rounded-lg my-2 flex flex-row gap-2 items-center">
                    <View className={`p-1 border rounded-full ${rankborderClasses}`}>
                      <View className={` w-16 h-16 text-center rounded-full  flex items-center justify-center ${rankClasses} `}>
                        <Text style={{ textShadow: '2px 2px 4px rgba(0, 0, 0, 0.6)' }} className="text-gray-800 text-center text-2xl font-pbold">{rank}</Text>
                      </View>
                    </View>
                    <Text className="text-white text-2xl font-psemibold "> {districtMap[districtId]} </Text>
                    <View>
                      <Text className="text-white font-pbold  text-4xl "> {total}</Text>
                    </View>
                  </View>
                </TouchableOpacity>
                <Collapsible collapsed={openIndex !== `general-${districtId}`}>
                  <View className="bg-gray-200 p-2 rounded-md">
                    {generalSubcategories.map((category) => (
                      <View key={category} className="flex flex-row items-center  p-4 justify-between px-6 border-b border-1 border-gray-100">
                        <Text className="text-xl font-pmedium "> {category}:</Text>
                        <TouchableOpacity
                          key={category}
                          onPress={() => {
                            handleSubcategoryClick(districtId, category)
                            setModalVisible(true)
                          }}
                        >
                          <Text className="text-xl font-pmedium "> {districtCategoryMarks[districtId]?.general[category] || 0}</Text>
                        </TouchableOpacity>
                      </View>
                    ))}
                  </View>
                </Collapsible>
              </View>
            )
          })}
          <TouchableOpacity onPress={toggleViewGeneral} className="mt-2">
            <Text className="text-blue-600">{showAllGeneral ? 'View Less' : 'View More'}</Text>
          </TouchableOpacity>
        </View>

        {/* Twalaba Category Section */}
        <View className="mb-10">
          <Text className="text-xl text-white font-semibold mt-4">Twalaba Category</Text>
          {adjustRankSlice(sortedTwalabaTotal, showAllTwalaba).map(({ districtId, total, rank }) => {
            const rankClasses = getRankClasses(rank);
            const rankborderClasses = getRankBorderClasses(rank);
            return (
              <View key={`twalaba-${districtId}`}>
                <TouchableOpacity onPress={() => toggleCollapse(`twalaba-${districtId}`)} >
                  <View className="bg-black-100  p-2 rounded-lg my-2 flex flex-row gap-2 items-center">
                    <View className={`p-1 border rounded-full ${rankborderClasses}`}>
                      <View className={` w-16 h-16 text-center rounded-full  flex items-center justify-center ${rankClasses} `}>
                        <Text style={{ textShadow: '2px 2px 4px rgba(0, 0, 0, 0.6)' }} className="text-gray-800 text-center text-2xl font-pbold">{rank}</Text>
                      </View>
                    </View>
                    <Text className="text-white text-2xl font-psemibold "> {districtMap[districtId]} </Text>
                    <View>
                      <Text className="text-white font-pbold  text-4xl "> {total}</Text>
                    </View>
                  </View>

                </TouchableOpacity>
                <Collapsible collapsed={openIndex !== `twalaba-${districtId}`}>
                  <View className="bg-gray-200 p-2 rounded-md">
                    {twalabaSubcategories.map((category) => (
                      <View key={category} className="flex flex-row items-center  p-4 justify-between px-6 border-b border-1 border-gray-100">
                        <Text className="text-xl font-pmedium "> {category}:</Text>
                        <Text className="text-xl font-pmedium "> {districtCategoryMarks[districtId]?.twalaba[category] || 0}</Text>
                      </View>
                    ))}
                  </View>
                </Collapsible>
              </View>
            )
          })}
          <TouchableOpacity onPress={toggleViewTwalaba} className="mt-2">
            <Text className="text-red-600">{showAllTwalaba ? 'View Less' : 'View More'}</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </SafeAreaView>
  );
};

export default ScoreBoard;


const styles = StyleSheet.create({
  container: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
  },
  openButton: {
    backgroundColor: "#007bff",
    paddingVertical: 10,
    paddingHorizontal: 20,
    borderRadius: 5,
  },
  buttonText: {
    color: "#fff",
    fontWeight: "bold",
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: "rgba(0, 0, 0, 0.5)", // Semi-transparent background
    justifyContent: "center",
    alignItems: "center",
  },
  modalContent: {
    width: 300,
    backgroundColor: "#fff",
    padding: 20,
    borderRadius: 10,
    alignItems: "center",
    shadowColor: "#000",
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 5, // For Android shadow
  },
  closeButton: {
    backgroundColor: "#dc3545",
    marginTop: 20,
    paddingVertical: 10,
    paddingHorizontal: 20,
    borderRadius: 5,
  },
  modalText: {
    fontSize: 18,
    fontWeight: "bold",
    textAlign: "center",
    marginBottom: 10,
  },
});